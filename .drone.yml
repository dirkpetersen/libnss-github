pipeline:
  build:
    image: dock.pw.fr/pw/debpkg:${DEBIAN_VERSION}
    commands:
      - echo "deb http://ftp.fr.debian.org/debian/ ${DEBIAN_VERSION}-backports main" > /etc/apt/sources.list.d/backports.list
      - apt-get update >/dev/null
      - '[ "${DEBIAN_VERSION}" = "stretch" ] && apt-get install -y cmake libhiredis-dev libhiredis-dbg valgrind redis-server clang || apt-get install -y -t ${DEBIAN_VERSION}-backports cmake libhiredis-dev libhiredis-dbg valgrind redis-server clang'
      - sed -i -e "s/6379/6380/" /etc/redis/redis.conf
      - echo "unixsocket /var/run/redis/redis-webconf.sock" >> /etc/redis/redis.conf
      - /etc/init.d/redis-server start
      - redis-cli -p 6380 SET USER/testuser "testuser:x:12345:54321:Web User:/home/testuser:/bin/false"
      - redis-cli -p 6380 SET USER/12345 "testuser:x:12345:54321:Web User:/home/testuser:/bin/false"
      - redis-cli -p 6380 SET GROUP/testgroup "testgroup:x:54321:www-data"
      - redis-cli -p 6380 SET GROUP/54321 "testgroup:x:54321:www-data"
      - redis-cli -p 6380 SET WEBHOST/website.com "website.com:www.website.com:testuser:/home/testuser/public_html/www/:/var/run/mysqld/mysql.sock:default:display_errors=1;magic_quotes_gpc=1;"
      - scan-build make
      - scan-build make test
      - make
      - make test 
      - valgrind ./test
      - dpkg-buildpackage -b

  pkg-testing:
    image: appleboy/drone-scp
    host: pippin.planet-work.net
    username: pkg
    source: ../*.deb
    target: incoming-testing/libnss-redis/${DEBIAN_VERSION}
    when:
        event: push

  aptly-testing:
    image: appleboy/drone-ssh
    host: pippin.planet-work.net
    user: pkg
    script:
      - aptly repo add debian-${DEBIAN_VERSION}-testing incoming-testing/libnss-redis/${DEBIAN_VERSION} && aptly publish update ${DEBIAN_VERSION}-testing debian 
    when:
      event: push

  pkg:
    image: appleboy/drone-scp
    host: pippin.planet-work.net
    username: pkg
    source: ../*.deb
    target: incoming/libnss-redis/${DEBIAN_VERSION}
    when:
        event: tag


  aptly:
    image: appleboy/drone-ssh
    host: pippin.planet-work.net
    user: pkg
    script:
      - aptly repo add debian-${DEBIAN_VERSION} incoming/libnss-redis/${DEBIAN_VERSION} && aptly publish update ${DEBIAN_VERSION} debian 
    when:
      event: tag

matrix:
  DEBIAN_VERSION:
    - wheezy
    - jessie
    - stretch

